"use strict";(self.webpackChunkmaptable_frontend=self.webpackChunkmaptable_frontend||[]).push([[298],{40978:(e,t,a)=>{a.d(t,{HF:()=>d});var i=a(37383),n=a(57323),s=a.n(n);class r{constructor(e){s()(this,"i",0),this.raw=e}peek(){if(this.i>this.raw.length)throw new Error("unexpected EOF");return this.raw[this.i]}skipWs(){if(!(this.i>=this.raw.length))for(let e=this.i;e<this.raw.length;e++){if(!o(this.raw.charAt(e)))return;this.i+=1}}scanStart(){this.skipWs();const e=this.peek();if("("!==e)throw new Error("expect '(' got ".concat(e));this.i++}scanContinue(){this.skipWs();const e=this.peek(),t=","===e;if(!t&&")"!==e)throw new Error("expect ',' or ')' got ".concat(e));return this.i++,t}scanCircle(){this.scanStart();const[e,t]=this.scanCoordinate();if(!t){const e=this.peek();throw new Error("expect ',' got ".concat(e))}this.i++,this.skipWs();const a=this.scanNumber(),i=this.peek();if(")"!==i)throw new Error("expect ')' got ".concat(i));return this.i++,[e[0],e[1],a]}scanCirlces(){this.scanStart();const e=[];for(;;){const t=this.scanCircle();e.push(t);if(!this.scanContinue())break}return e}scanNumber(){this.skipWs();let e="",t=this.peek();for(;c(t);)this.i+=1,e+=t,t=this.peek();const a=Number(e);if(Number.isNaN(a))throw new Error("number parse error ".concat(e));return a}scanCoordinate(){if(this.skipWs(),this.i>this.raw.length)throw new Error("unexpected EOF");const e=this.scanNumber();this.skipWs();const t=this.scanNumber();this.skipWs();const a=this.peek(),i=","===a;if(!i&&")"!==a)throw new Error("expect ',' or ')' got ".concat(a));return this.i++,[[e,t],i]}scanCoordinates(e){if(this.scanStart(),e)try{this.scanStart()}catch(a){e=!1}const t=[];for(;;){const[a,i]=this.scanCoordinate();if(t.push(a),!i){if(e){if(this.scanContinue()){this.scanStart();continue}}return t}if(e)throw new Error("expect ')' got ','")}}scanPolyData(e){this.scanStart();const t=[];for(;;){const a=this.scanCoordinates(!1);if(e){if(a.length<4)throw new Error("a polygon ring must have at least 4 points, got ".concat(a.length));if(a[0][0]!==a[a.length-1][0]||a[0][1]!==a[a.length-1][1])throw new Error("a polygon ring must be closed")}else if(a.length<2)throw new Error("must have at least 2 points, got ".concat(a.length));if(t.push(a),!this.scanContinue())return t}}scanMultiPolyData(){this.scanStart();const e=[];for(;;){const t=this.scanPolyData(!0);if(e.push(t),!this.scanContinue())return e}}scanIndent(){if(this.skipWs(),this.i>=this.raw.length)throw new Error("unexpected EOF");let e="",t=0;for(t=this.i;t<this.raw.length;t++){const a=this.raw.charAt(t);if(!l(a))break;e+=a.toUpperCase(),this.i+=1}if(0===e.length)throw new Error("indent not found");return e}scanGeometry(){const e=this.scanIndent();let t;switch(e){case"CIRCLE":t={type:"Circle",coordinates:this.scanCircle()};break;case"MULTICIRCLE":t={type:"MultiCircle",coordinates:this.scanCirlces()};break;case"POINT":{const e=this.scanCoordinates(!1);if(1!==e.length)throw new Error("expect 1 got ".concat(e.length," points"));t={type:"Point",coordinates:e[0]};break}case"MULTIPOINT":t={type:"MultiPoint",coordinates:this.scanCoordinates(!0)};break;case"LINESTRING":{const e=this.scanCoordinates(!1);if(e.length<2)throw new Error("must have at least 2 points, got ".concat(e.length));t={type:"LineString",coordinates:e};break}case"POLYGON":t={type:"Polygon",coordinates:this.scanPolyData(!0)};break;case"MULTIPOLYGON":t={type:"MultiPolygon",coordinates:this.scanMultiPolyData()};break;case"MULTILINESTRING":t={type:"MultiLineString",coordinates:this.scanPolyData(!1)};break;default:throw new Error("unknown geometry ".concat(e))}if(this.i+1<=this.raw.length)throw new Error("expect EOF");return t}}function o(e){return 1===e.length&&[" ","\n","\t","\r"].includes(e)}function c(e){return[".","-","0","1","2","3","4","5","6","7","8","9"].includes(e)}function l(e){return 1===e.length&&e.match(/[a-zA-Z]/i)}a(58205);a(40517),a(67045),a(80128),a(80593);i.default.GCJ02,i.default.WGS84,i.default.BD09MC;function d(e){return function(e){return new r(e).scanGeometry()}(e)}},36441:(e,t,a)=>{a.d(t,{q:()=>i});const i="china-ADM1-nineDashLine"},42015:(e,t,a)=>{a.d(t,{Bb:()=>m,Hk:()=>h,Yk:()=>f,a:()=>g,yy:()=>u});var i=a(79129),n=a(27077),s=a(42514),r=a(6200),o=a(35546),c=a(70323),l=a(89063),d=a.n(l);"".concat("https://icon-cdn.maptable.com","/assets/boundary_data");const u={admin0:0,admin1:1,admin2:2,admin3:3},h=((0,i.Em)({id:"qIy+j6",defaultMessage:"Admin0"}),(0,i.Em)({id:"Qxkkdf",defaultMessage:"Admin1"}),(0,i.Em)({id:"8IvwT/",defaultMessage:"Admin2"}),(0,i.Em)({id:"Lci7UK",defaultMessage:"Admin3"}),{minMatchCharLength:2,keys:["name_zh","name_en","name_local"],includeScore:!0}),f={isCaseSensitive:!1,includeScore:!0,threshold:0,keys:["name_alias","iso","iso2"]};const g=.2;function m(e,t){switch(t){case"sum":return(0,n.Z)(e);case"min":return(0,s.Z)(e);case"max":return(0,r.Z)(e);case"mean":return(0,o.Z)(e);case"median":return(0,c.Z)(e);case"nonEmptyCount":return d()(e.filter((e=>null!=e)));default:return d()(e)}}(0,i.Em)({id:"jqdzk6",defaultMessage:"World"}),(0,i.Em)({id:"1q/ois",defaultMessage:"China"}),(0,i.Em)({id:"whQZpU",defaultMessage:"USA"}),(0,i.Em)({id:"3Rh+pv",defaultMessage:"Japan"}),(0,i.Em)({id:"PGzyr2",defaultMessage:"Germany"}),(0,i.Em)({id:"9N69Wd",defaultMessage:"UK"}),(0,i.Em)({id:"9KADbj",defaultMessage:"France"}),(0,i.Em)({id:"VzQxqn",defaultMessage:"Italy"}),(0,i.Em)({id:"2abiy0",defaultMessage:"Canada"}),(0,i.Em)({id:"zJ+Qdi",defaultMessage:"Brazil"}),(0,i.Em)({id:"QXG+La",defaultMessage:"Mexico"}),(0,i.Em)({id:"rhaGlx",defaultMessage:"Singapore"}),(0,i.Em)({id:"vQOevT",defaultMessage:"Indonesia"}),(0,i.Em)({id:"b7zond",defaultMessage:"Malaysia"}),(0,i.Em)({id:"+ieU8R",defaultMessage:"Vietnam"}),(0,i.Em)({id:"dQZuWX",defaultMessage:"Thailand"}),(0,i.Em)({id:"RRQ7fk",defaultMessage:"Philippines"}),(0,i.Em)({id:"ZwXv1C",defaultMessage:"Austria"}),(0,i.Em)({id:"o5InVy",defaultMessage:"Belgium"}),(0,i.Em)({id:"OjT4Gq",defaultMessage:"Denmark"}),(0,i.Em)({id:"OIc/xw",defaultMessage:"Finland"}),(0,i.Em)({id:"cOtCHW",defaultMessage:"Sweden"}),(0,i.Em)({id:"yil/vB",defaultMessage:"Greece"}),(0,i.Em)({id:"hT/s2i",defaultMessage:"Netherlands"}),(0,i.Em)({id:"SZjU9E",defaultMessage:"Poland"}),(0,i.Em)({id:"67jBS8",defaultMessage:"Portugal"}),(0,i.Em)({id:"GL9Msi",defaultMessage:"Spain"}),(0,i.Em)({id:"gEWjsM",defaultMessage:"Bangladesh"}),(0,i.Em)({id:"fIBorD",defaultMessage:"Congo-Kinshasa"}),(0,i.Em)({id:"BIR9MS",defaultMessage:"Egypt"}),(0,i.Em)({id:"u5SBAU",defaultMessage:"Pakistan"}),(0,i.Em)({id:"t50FYQ",defaultMessage:"Zambia"}),(0,i.Em)({id:"D4A2LZ",defaultMessage:"Australia"}),(0,i.Em)({id:"OhkbDU",defaultMessage:"Russia"}),(0,i.Em)({id:"tnrxhT",defaultMessage:"South Korea"}),(0,i.Em)({id:"k/pu+/",defaultMessage:"Turkey"}),(0,i.Em)({id:"cbMqh0",defaultMessage:"Saudi Arabia"}),(0,i.Em)({id:"ERkh0f",defaultMessage:"Switzerland"}),(0,i.Em)({id:"wHkOq4",defaultMessage:"Argentina"}),(0,i.Em)({id:"fGxzwb",defaultMessage:"Ireland"}),(0,i.Em)({id:"vwXIZQ",defaultMessage:"Israel"}),(0,i.Em)({id:"eMHa+3",defaultMessage:"United Arab Emirates"}),(0,i.Em)({id:"mdq/wu",defaultMessage:"Norway"}),(0,i.Em)({id:"XR8z3v",defaultMessage:"South Africa"})},29630:(e,t,a)=>{a.d(t,{Iv:()=>l,TK:()=>c,zK:()=>o});var i=a(33382);const n="MT-RegionMatchDB",s="matchCache",r=20250815;async function o(e){const t="".concat(n,"-").concat(e);try{return await(0,i.X3)(t,r,{upgrade(e,t){if(t<r&&e.objectStoreNames.contains(s)&&e.deleteObjectStore(s),!e.objectStoreNames.contains(s)){e.createObjectStore(s,{keyPath:"key"}).createIndex("by-key","key",{unique:!0})}}})}catch{}}async function c(e,t){try{if(!t)return;const a=await t.getFromIndex(s,"by-key",e);return null===a||void 0===a?void 0:a.value}catch{}}async function l(e,t){try{if(!t)return;const a=t.transaction(s,"readwrite"),i=a.objectStore(s);await Promise.all([...Object.entries(e).map((e=>{let[t,a]=e;return i.put({key:t,value:a})})),a.done])}catch{}}},13424:(e,t,a)=>{a.d(t,{Lu:()=>l,XN:()=>u,cn:()=>d,hb:()=>c});var i=a(8264),n=a.n(i),s=a(56356),r=a.n(s),o=a(42015);function c(e,t){var a;if(!t)return null;const i=e.cells[t.id];if("singleChoice"===t.type){var n;const e=null===(n=t.typeOptions)||void 0===n?void 0:n.choices.find((e=>e.id===i));return r()((null===e||void 0===e?void 0:e.name)||"")}if("lookup"===t.type&&"singleChoice"===(null===(a=t.typeOptions)||void 0===a?void 0:a.lookupColumnType)){var s;const e=null===(s=t.typeOptions.lookupColumnTypeOptions)||void 0===s?void 0:s.choices.find((e=>Array.isArray(i)?i.includes(e.id):e.id===i));return r()((null===e||void 0===e?void 0:e.name)||"")}return r()(i)}const l=async(e,t,a)=>{var i,s;if(!e)return null;const r=t.search(e),o=null!==(i=r.filter((e=>e.item.name_zh)))&&void 0!==i&&i[0]?[null===(s=r.filter((e=>e.item.name_zh)))||void 0===s?void 0:s[0]]:[],c=a.search(e);return n()(o,c).filter(Boolean)},d=(e,t)=>{if(0===(null===e||void 0===e?void 0:e.length)||!t)return e;const a=o.yy[t];return e.filter((e=>{var t;return Number(null===(t=e.item.level)||void 0===t?void 0:t.replace("ADM",""))>=a}))},u=async e=>{var t;let{directFuzzyMatchResult:a,specifyMatchValue:i,strictFUse:n,fuzzyFUse:s,aggregateBy:r}=e;const o=d(a,r);if(!o.length)return null;const c=null===o||void 0===o?void 0:o[0];if(!i||!c.item.parentId)return c;const u=await l(i,n,s);if(!u)return c;const h=u.filter((e=>"ADM3"!==e.item.level)),f=null===h||void 0===h?void 0:h[0];if(!f)return c;if(null!==(t=f.item)&&void 0!==t&&t.parentId){return o.find((e=>e.item.parentId===f.item.id))}return o.find((e=>e.item.gid1===f.item.gid1))}},93033:(e,t,a)=>{a.d(t,{l:()=>S});var i=a(57323),n=a.n(i),s=a(20780),r=a(55349),o=a.n(r),c=a(17646),l=a.n(c),d=a(56356),u=a.n(d),h=a(468),f=a.n(h),g=a(53813),m=a.n(g),p=a(82813),y=a.n(p),w=a(42015),M=a(36441),v=a(46131),E=a(29630),I=a(13424);class b{constructor(e,t){n()(this,"cache",new Map),this.strictSpecifyFUse=e,this.fuzzySpecifyFUse=t}async getSpecifyMatch(e){if(this.cache.has(e))return this.cache.get(e);const t=await(0,I.Lu)(e,this.strictSpecifyFUse,this.fuzzySpecifyFUse);if(null===t||void 0===t||!t.length)return this.cache.set(e,null),null;const a=(null===t||void 0===t?void 0:t[0])||null;return this.cache.set(e,a),a}async preloadSpecifyMatches(e){const t=[...e].filter((e=>e&&!this.cache.has(e)));for(let a=0;a<t.length;a+=20){const e=t.slice(a,a+20);await Promise.all(e.map((e=>this.getSpecifyMatch(e))))}}clear(){this.cache.clear(),this.strictSpecifyFUse=new s.Z([]),this.fuzzySpecifyFUse=new s.Z([])}}class k{constructor(e,t){this.strictFUse=e.strictFUse,this.fuzzyFUse=e.fuzzyFUse,this.specifyCache=new b(e.strictSpecifyFUse,e.fuzzySpecifyFUse),this.aggregateBy=t}async findBestMatchResultOptimized(e){var t;let{directFuzzyMatchResult:a,specifyMatchValue:i}=e;const n=(0,I.cn)(a,this.aggregateBy);if(!n.length)return null;const s=n[0];if(!i||!s.item.parentId)return s;const r=await this.specifyCache.getSpecifyMatch(i);if(!r)return s;if(null!==(t=r.item)&&void 0!==t&&t.parentId){return n.find((e=>e.item.parentId===r.item.id))||s}return n.find((e=>e.item.gid1===r.item.gid1))||s}async preloadSpecifyMatches(e){const t=new Set;e.forEach((e=>{e.specifyByName&&u()(e.specifyByName)&&t.add(u()(e.specifyByName))})),await this.specifyCache.preloadSpecifyMatches(t)}async processRegionMatching(e,t){const a=[],i=new Map,n={},s=new Map;e.forEach((e=>{if(!e.regionName||e.regionName.length>85)return void a.push(e);const t=e.regionName;s.has(t)||s.set(t,[]),s.get(t).push(e)}));for(const[c,l]of s){const e=await(0,I.Lu)(c,this.strictFUse,this.fuzzyFUse);if(null===e||void 0===e||!e.length){l.forEach((e=>{const t="".concat(e.regionName,"-").concat(e.specifyByName||"","-").concat(this.aggregateBy||"");n[t]=null,a.push(e)}));continue}const s=new Map;l.forEach((e=>{const t=e.specifyByName||"";s.has(t)||s.set(t,[]),s.get(t).push(e)}));for(const[,c]of s){const s=c[0],l="".concat(s.regionName,"-").concat(s.specifyByName||"","-").concat(this.aggregateBy||"");let d=await(0,E.TK)(l,t);var r;if(void 0===d)d=await this.findBestMatchResultOptimized({directFuzzyMatchResult:e,specifyMatchValue:s.specifyByName}),((null===(r=d)||void 0===r?void 0:r.score)||0)>w.a&&(d=null),n[l]=d||null;c.forEach((e=>{o()(d)?a.push(e):i.set(e.rowId,d)}))}}return{matchResults:i,notMatchedItems:a,cacheToWrite:n}}clear(){this.specifyCache.clear(),this.fuzzyFUse=new s.Z([]),this.strictFUse=new s.Z([])}}async function S(e){let{locale:t,mapInfo:a,tableNode:i,geojson:n,allIndexOptions:r,dashboardData:o}=e;const c=[],d=[],h=m()(n),{regionDimensionFieldID:g,regionIndexStatsFieldID:p,specifyByFieldID:v,regionConfig:b}=a,{dimension:S,aggregateBy:z,regionId:N,indexStatsMethod:F}=b;if("region"!==S||!g||!p||!h||!i)return null===h||void 0===h||h.features.map((e=>(e.properties=f()(e.properties,["aggregationValue","aggregationFormatValue"]),e))),{computingGeoJSON:h,notMatchedItems:c,totalItems:d};const U=N||"china",D=y()(r),B=i.rows||[],x=i.columns||[],O=JSON.stringify((null===x||void 0===x?void 0:x.find((e=>e.id===p)))||{}),A=x.find((e=>e.id===g)),P=x.find((e=>e.id===v)),R=new Map,T=new Map(h.features.map((e=>{var t;return[null===(t=e.properties)||void 0===t?void 0:t.id,e]}))),V=new Map(D.map((e=>[e.id,e.parentId]))),L=!!P;let Z=[],G=F;o?(l()(o,((e,t)=>{l()(e,((e,a)=>{Z.push({regionName:u()(t),specifyByName:L?a:null,value:e.value,dashboardValue:"mean"===G?e:void 0,rowId:"".concat(t,"-").concat(a)})}))})),"count"!==F&&"nonEmptyCount"!==F||(G="sum")):Z=B.reduce(((e,t)=>{const a=(0,I.hb)(t,A);if(!a)return e;const i=t.cells[p],n=t.id;return e.push({regionName:a,specifyByName:(0,I.hb)(t,P),value:i,rowId:n}),e}),[]),d.push(...Z);const W=new k(function(e){const t=new s.Z(e,w.Hk),a=new s.Z(e,w.Yk),i=e.filter((e=>"ADM3"!==e.level)),n=new s.Z(i,w.Hk);return{strictFUse:a,fuzzyFUse:t,strictSpecifyFUse:new s.Z(i,w.Yk),fuzzySpecifyFUse:n}}(D),z);await W.preloadSpecifyMatches(Z);const j=await(0,E.zK)(U);let _=new Map;try{const e=await W.processRegionMatching(Z,j);_=e.matchResults,c.push(...e.notMatchedItems),await(0,E.Iv)(e.cacheToWrite,j)}finally{W.clear();try{null===j||void 0===j||j.close()}catch{}}for(const[s,l]of _){var q;const e=Z.find((e=>e.rowId===s));if(!e||!l)continue;const t=null===(q=l.item)||void 0===q?void 0:q.id;if(!t)continue;const a=e.value;R.has(t)||R.set(t,[]),R.get(t).push({value:a,rowId:e.rowId,dashboardValue:e.dashboardValue});let i=t;for(let n=0;n<2;n++){const t=V.get(i);if(!t)break;R.has(t)||R.set(t,[]),R.get(t).push({value:a,rowId:e.rowId,dashboardValue:e.dashboardValue}),i=t}}for(const[s,l]of R){var Q,K,H;const e=T.get(s);if(!e||s===M.q)continue;const a="zh-CN"===t?(null===(Q=e.properties)||void 0===Q?void 0:Q.display_name)||(null===(K=e.properties)||void 0===K?void 0:K.name_zh):null===(H=e.properties)||void 0===H?void 0:H.name_en;e.type="Feature";let i=l.map((e=>e.value));if("mean"===G&&l.length>1){const{sum:e,count:t,isDashboardValue:a}=l.reduce(((e,t)=>(t.dashboardValue&&(e.sum+=t.dashboardValue.sum||0,e.count+=t.dashboardValue.count||0,e.isDashboardValue=!0),e)),{sum:0,count:0,isDashboardValue:!1});a&&(i=[t>0?e/t:0])}const n=C({aggregationValue:i,indexStatsMethod:F,columns:x,regionDimensionFieldID:g,regionIndexStatsFieldID:p,name:a});e.properties={...e.properties||{},name:a,tooltip:n,aggregationValue:i,aggregationMethod:G,rowIds:l.map((e=>{var t;return null===(t=e.rowId)||void 0===t?void 0:t.split("-")[0]})),indexStatsColumn:O}}return{computingGeoJSON:h,notMatchedItems:c,totalItems:d}}function C(e){var t,a;let{aggregationValue:i,indexStatsMethod:n,columns:s,regionDimensionFieldID:r,regionIndexStatsFieldID:o,name:c}=e;const l=(0,w.Bb)(i,n),d=null===s||void 0===s||null===(t=s.find((e=>e.id===r)))||void 0===t?void 0:t.name,u=null===s||void 0===s||null===(a=s.find((e=>e.id===o)))||void 0===a?void 0:a.name,h=l?(0,v.IG)(l):null;return"".concat(d,": ").concat(c,"\n").concat(null!==u&&void 0!==u?u:"Count",": ").concat(h)}}}]);