"use strict";(self.webpackChunkmaptable_frontend=self.webpackChunkmaptable_frontend||[]).push([[298],{40978:(e,t,n)=>{n.d(t,{HF:()=>u});var a=n(37383),i=n(57323),s=n.n(i);class o{constructor(e){s()(this,"i",0),this.raw=e}peek(){if(this.i>this.raw.length)throw new Error("unexpected EOF");return this.raw[this.i]}skipWs(){if(!(this.i>=this.raw.length))for(let e=this.i;e<this.raw.length;e++){if(!r(this.raw.charAt(e)))return;this.i+=1}}scanStart(){this.skipWs();const e=this.peek();if("("!==e)throw new Error("expect '(' got ".concat(e));this.i++}scanContinue(){this.skipWs();const e=this.peek(),t=","===e;if(!t&&")"!==e)throw new Error("expect ',' or ')' got ".concat(e));return this.i++,t}scanCircle(){this.scanStart();const[e,t]=this.scanCoordinate();if(!t){const e=this.peek();throw new Error("expect ',' got ".concat(e))}this.i++,this.skipWs();const n=this.scanNumber(),a=this.peek();if(")"!==a)throw new Error("expect ')' got ".concat(a));return this.i++,[e[0],e[1],n]}scanCirlces(){this.scanStart();const e=[];for(;;){const t=this.scanCircle();e.push(t);if(!this.scanContinue())break}return e}scanNumber(){this.skipWs();let e="",t=this.peek();for(;c(t);)this.i+=1,e+=t,t=this.peek();const n=Number(e);if(Number.isNaN(n))throw new Error("number parse error ".concat(e));return n}scanCoordinate(){if(this.skipWs(),this.i>this.raw.length)throw new Error("unexpected EOF");const e=this.scanNumber();this.skipWs();const t=this.scanNumber();this.skipWs();const n=this.peek(),a=","===n;if(!a&&")"!==n)throw new Error("expect ',' or ')' got ".concat(n));return this.i++,[[e,t],a]}scanCoordinates(e){if(this.scanStart(),e)try{this.scanStart()}catch(n){e=!1}const t=[];for(;;){const[n,a]=this.scanCoordinate();if(t.push(n),!a){if(e){if(this.scanContinue()){this.scanStart();continue}}return t}if(e)throw new Error("expect ')' got ','")}}scanPolyData(e){this.scanStart();const t=[];for(;;){const n=this.scanCoordinates(!1);if(e){if(n.length<4)throw new Error("a polygon ring must have at least 4 points, got ".concat(n.length));if(n[0][0]!==n[n.length-1][0]||n[0][1]!==n[n.length-1][1])throw new Error("a polygon ring must be closed")}else if(n.length<2)throw new Error("must have at least 2 points, got ".concat(n.length));if(t.push(n),!this.scanContinue())return t}}scanMultiPolyData(){this.scanStart();const e=[];for(;;){const t=this.scanPolyData(!0);if(e.push(t),!this.scanContinue())return e}}scanIndent(){if(this.skipWs(),this.i>=this.raw.length)throw new Error("unexpected EOF");let e="",t=0;for(t=this.i;t<this.raw.length;t++){const n=this.raw.charAt(t);if(!l(n))break;e+=n.toUpperCase(),this.i+=1}if(0===e.length)throw new Error("indent not found");return e}scanGeometry(){const e=this.scanIndent();let t;switch(e){case"CIRCLE":t={type:"Circle",coordinates:this.scanCircle()};break;case"MULTICIRCLE":t={type:"MultiCircle",coordinates:this.scanCirlces()};break;case"POINT":{const e=this.scanCoordinates(!1);if(1!==e.length)throw new Error("expect 1 got ".concat(e.length," points"));t={type:"Point",coordinates:e[0]};break}case"MULTIPOINT":t={type:"MultiPoint",coordinates:this.scanCoordinates(!0)};break;case"LINESTRING":{const e=this.scanCoordinates(!1);if(e.length<2)throw new Error("must have at least 2 points, got ".concat(e.length));t={type:"LineString",coordinates:e};break}case"POLYGON":t={type:"Polygon",coordinates:this.scanPolyData(!0)};break;case"MULTIPOLYGON":t={type:"MultiPolygon",coordinates:this.scanMultiPolyData()};break;case"MULTILINESTRING":t={type:"MultiLineString",coordinates:this.scanPolyData(!1)};break;default:throw new Error("unknown geometry ".concat(e))}if(this.i+1<=this.raw.length)throw new Error("expect EOF");return t}}function r(e){return 1===e.length&&[" ","\n","\t","\r"].includes(e)}function c(e){return[".","-","0","1","2","3","4","5","6","7","8","9"].includes(e)}function l(e){return 1===e.length&&e.match(/[a-zA-Z]/i)}n(58205);n(40517),n(67045),n(80128),n(80593);a.default.GCJ02,a.default.WGS84,a.default.BD09MC;function u(e){return function(e){return new o(e).scanGeometry()}(e)}},36441:(e,t,n)=>{n.d(t,{q:()=>a});const a="china-ADM1-nineDashLine"},42015:(e,t,n)=>{n.d(t,{Bb:()=>g,Hk:()=>h,Yk:()=>f,a:()=>p,yy:()=>d});var a=n(79129),i=n(27077),s=n(42514),o=n(6200),r=n(35546),c=n(70323),l=n(89063),u=n.n(l);"".concat("https://icon-cdn.maptable.com","/assets/boundary_data");const d={admin0:0,admin1:1,admin2:2,admin3:3},h=((0,a.Em)({id:"qIy+j6",defaultMessage:"Admin0"}),(0,a.Em)({id:"Qxkkdf",defaultMessage:"Admin1"}),(0,a.Em)({id:"8IvwT/",defaultMessage:"Admin2"}),(0,a.Em)({id:"Lci7UK",defaultMessage:"Admin3"}),{minMatchCharLength:2,keys:["name_zh","name_en","name_local"],includeScore:!0}),f={isCaseSensitive:!1,includeScore:!0,threshold:0,keys:["name_alias","iso","iso2"]};const p=.2;function g(e,t){switch(t){case"sum":return(0,i.Z)(e);case"min":return(0,s.Z)(e);case"max":return(0,o.Z)(e);case"mean":return(0,r.Z)(e);case"median":return(0,c.Z)(e);case"nonEmptyCount":return u()(e.filter((e=>null!=e)));default:return u()(e)}}(0,a.Em)({id:"jqdzk6",defaultMessage:"World"}),(0,a.Em)({id:"1q/ois",defaultMessage:"China"}),(0,a.Em)({id:"whQZpU",defaultMessage:"USA"}),(0,a.Em)({id:"3Rh+pv",defaultMessage:"Japan"}),(0,a.Em)({id:"PGzyr2",defaultMessage:"Germany"}),(0,a.Em)({id:"9N69Wd",defaultMessage:"UK"}),(0,a.Em)({id:"9KADbj",defaultMessage:"France"}),(0,a.Em)({id:"VzQxqn",defaultMessage:"Italy"}),(0,a.Em)({id:"2abiy0",defaultMessage:"Canada"}),(0,a.Em)({id:"zJ+Qdi",defaultMessage:"Brazil"}),(0,a.Em)({id:"QXG+La",defaultMessage:"Mexico"}),(0,a.Em)({id:"rhaGlx",defaultMessage:"Singapore"}),(0,a.Em)({id:"vQOevT",defaultMessage:"Indonesia"}),(0,a.Em)({id:"b7zond",defaultMessage:"Malaysia"}),(0,a.Em)({id:"+ieU8R",defaultMessage:"Vietnam"}),(0,a.Em)({id:"dQZuWX",defaultMessage:"Thailand"}),(0,a.Em)({id:"RRQ7fk",defaultMessage:"Philippines"}),(0,a.Em)({id:"ZwXv1C",defaultMessage:"Austria"}),(0,a.Em)({id:"o5InVy",defaultMessage:"Belgium"}),(0,a.Em)({id:"OjT4Gq",defaultMessage:"Denmark"}),(0,a.Em)({id:"OIc/xw",defaultMessage:"Finland"}),(0,a.Em)({id:"cOtCHW",defaultMessage:"Sweden"}),(0,a.Em)({id:"yil/vB",defaultMessage:"Greece"}),(0,a.Em)({id:"hT/s2i",defaultMessage:"Netherlands"}),(0,a.Em)({id:"SZjU9E",defaultMessage:"Poland"}),(0,a.Em)({id:"67jBS8",defaultMessage:"Portugal"}),(0,a.Em)({id:"GL9Msi",defaultMessage:"Spain"}),(0,a.Em)({id:"gEWjsM",defaultMessage:"Bangladesh"}),(0,a.Em)({id:"fIBorD",defaultMessage:"Congo-Kinshasa"}),(0,a.Em)({id:"BIR9MS",defaultMessage:"Egypt"}),(0,a.Em)({id:"u5SBAU",defaultMessage:"Pakistan"}),(0,a.Em)({id:"t50FYQ",defaultMessage:"Zambia"}),(0,a.Em)({id:"D4A2LZ",defaultMessage:"Australia"}),(0,a.Em)({id:"OhkbDU",defaultMessage:"Russia"}),(0,a.Em)({id:"tnrxhT",defaultMessage:"South Korea"}),(0,a.Em)({id:"k/pu+/",defaultMessage:"Turkey"}),(0,a.Em)({id:"cbMqh0",defaultMessage:"Saudi Arabia"}),(0,a.Em)({id:"ERkh0f",defaultMessage:"Switzerland"}),(0,a.Em)({id:"wHkOq4",defaultMessage:"Argentina"}),(0,a.Em)({id:"fGxzwb",defaultMessage:"Ireland"}),(0,a.Em)({id:"vwXIZQ",defaultMessage:"Israel"}),(0,a.Em)({id:"eMHa+3",defaultMessage:"United Arab Emirates"}),(0,a.Em)({id:"mdq/wu",defaultMessage:"Norway"}),(0,a.Em)({id:"XR8z3v",defaultMessage:"South Africa"})},29630:(e,t,n)=>{n.d(t,{Iv:()=>l,TK:()=>c,zK:()=>r});var a=n(33382);const i="MT-RegionMatchDB",s="matchCache",o=20251103;async function r(e){const t="".concat(i,"-").concat(e);try{return await(0,a.X3)(t,o,{upgrade(e,t){if(t<o&&e.objectStoreNames.contains(s)&&e.deleteObjectStore(s),!e.objectStoreNames.contains(s)){e.createObjectStore(s,{keyPath:"key"}).createIndex("by-key","key",{unique:!0})}}})}catch{}}async function c(e,t){try{if(!t)return;const n=await t.getFromIndex(s,"by-key",e);return null===n||void 0===n?void 0:n.value}catch{}}async function l(e,t){try{if(!t)return;const n=t.transaction(s,"readwrite"),a=n.objectStore(s);await Promise.all([...Object.entries(e).map((e=>{let[t,n]=e;return a.put({key:t,value:n})})),n.done])}catch{}}},13424:(e,t,n)=>{n.d(t,{Hr:()=>f,Lu:()=>c,XN:()=>u,cn:()=>l,gB:()=>d,hb:()=>r,vg:()=>h});var a=n(56356),i=n.n(a),s=n(42015),o=n(46131);function r(e,t){var n;if(!t)return null;const a=e.cells[t.id];if("singleChoice"===t.type){var s;const e=null===(s=t.typeOptions)||void 0===s?void 0:s.choices.find((e=>e.id===a));return i()((null===e||void 0===e?void 0:e.name)||"")}if("lookup"===t.type&&"singleChoice"===(null===(n=t.typeOptions)||void 0===n?void 0:n.lookupColumnType)){var o;const e=null===(o=t.typeOptions.lookupColumnTypeOptions)||void 0===o?void 0:o.choices.find((e=>Array.isArray(a)?a.includes(e.id):e.id===a));return i()((null===e||void 0===e?void 0:e.name)||"")}return i()(a)}const c=async(e,t,n)=>{var a;if(!e)return null;const i=t.search(e),s=n.search(e),o=[],r=new Set,c=i.find((e=>{var t;return Boolean(null===(t=e.item)||void 0===t?void 0:t.name_zh)}));null!==c&&void 0!==c&&null!==(a=c.item)&&void 0!==a&&a.id&&(r.add(c.item.id),o.push(c));for(const u of s){var l;const e=null===(l=u.item)||void 0===l?void 0:l.id;e&&!r.has(e)&&(o.push(u),r.add(e))}return o},l=(e,t)=>{if(0===(null===e||void 0===e?void 0:e.length)||!t)return e;const n=s.yy[t];return e.filter((e=>{var t;return Number(null===(t=e.item.level)||void 0===t?void 0:t.replace("ADM",""))>=n}))},u=async e=>{var t;let{directFuzzyMatchResult:n,specifyMatchValue:a,strictFUse:i,fuzzyFUse:s,aggregateBy:o}=e;const r=l(n,o);if(!r.length)return null;const u=null===r||void 0===r?void 0:r[0];if(!a||!u.item.parentId)return u;const d=await c(a,i,s);if(!d)return u;const h=d.filter((e=>"ADM3"!==e.item.level)),f=null===h||void 0===h?void 0:h[0];if(!f)return u;if(null!==(t=f.item)&&void 0!==t&&t.parentId){return r.find((e=>e.item.parentId===f.item.id))}return r.find((e=>e.item.gid1===f.item.gid1))};function d(e){var t;let{aggregationValue:n,indexStatsMethod:a,columns:i,regionIndexStatsFieldID:r,name:c,ratio:l,rank:u}=e;const d=(0,s.Bb)(n,a),h=null===i||void 0===i||null===(t=i.find((e=>e.id===r)))||void 0===t?void 0:t.name,f=d?(0,o.IG)(d):null,p=null!=l&&l>=0?"".concat(l.toFixed(2),"%"):"-",g=null!=u&&u>0?u.toString():"-";return"".concat(c,"\n").concat(null!==h&&void 0!==h?h:"Count",": ").concat(f,"\nRatio: ").concat(p,"\nRank: ").concat(g)}function h(e,t){if("mean"===t&&e.length>1){const{sum:t,count:n,isDashboardValue:a}=e.reduce(((e,t)=>(t.dashboardValue&&(e.sum+=t.dashboardValue.sum||0,e.count+=t.dashboardValue.count||0,e.isDashboardValue=!0),e)),{sum:0,count:0,isDashboardValue:!1});if(a)return[n>0?t/n:0]}return e.map((e=>e.value))}function f(e,t){const n=t?new Set(t):new Set,a=[],i=new Map;let o=0;for(const f of e){var r,c,l;const e=null===(r=f.properties)||void 0===r?void 0:r.id;if(!e||n.has(e))continue;const t=null===(c=f.properties)||void 0===c?void 0:c.aggregationValue;if(!t||0===t.length)continue;const u=null===(l=f.properties)||void 0===l?void 0:l.aggregationMethod,d=(0,s.Bb)(t,u);null==d||isNaN(d)||(a.push({id:e,value:d}),i.set(e,d),o+=d)}a.sort(((e,t)=>t.value-e.value));const u=new Map;let d=1,h=null;for(let s=0;s<a.length;s++){const e=a[s];null!==h&&e.value!==h&&(d=s+1),u.set(e.id,d),h=e.value}return{valueMap:i,totalSum:o,rankMap:u}}},93033:(e,t,n)=>{n.d(t,{l:()=>k});var a=n(57323),i=n.n(a),s=n(20780),o=n(55349),r=n.n(o),c=n(17646),l=n.n(c),u=n(56356),d=n.n(u),h=n(468),f=n.n(h),p=n(82813),g=n.n(p),m=n(42015),y=n(36441),v=n(29630),w=n(13424);class M{constructor(e,t){i()(this,"cache",new Map),this.strictSpecifyFUse=e,this.fuzzySpecifyFUse=t}async getSpecifyMatch(e){if(this.cache.has(e))return this.cache.get(e);const t=await(0,w.Lu)(e,this.strictSpecifyFUse,this.fuzzySpecifyFUse);if(null===t||void 0===t||!t.length)return this.cache.set(e,null),null;const n=(null===t||void 0===t?void 0:t[0])||null;return this.cache.set(e,n),n}async preloadSpecifyMatches(e){const t=[...e].filter((e=>e&&!this.cache.has(e)));for(let n=0;n<t.length;n+=20){const e=t.slice(n,n+20);await Promise.all(e.map((e=>this.getSpecifyMatch(e))))}}clear(){this.cache.clear(),this.strictSpecifyFUse=new s.Z([]),this.fuzzySpecifyFUse=new s.Z([])}}class E{constructor(e,t){this.strictFUse=e.strictFUse,this.fuzzyFUse=e.fuzzyFUse,this.specifyCache=new M(e.strictSpecifyFUse,e.fuzzySpecifyFUse),this.aggregateBy=t}async findBestMatchResultOptimized(e){var t;let{directFuzzyMatchResult:n,specifyMatchValue:a}=e;const i=(0,w.cn)(n,this.aggregateBy);if(!i.length)return null;const s=i[0];if(!a||!s.item.parentId)return s;const o=await this.specifyCache.getSpecifyMatch(a);if(!o)return s;if(null!==(t=o.item)&&void 0!==t&&t.parentId){return i.find((e=>e.item.parentId===o.item.id))||s}return i.find((e=>e.item.gid1===o.item.gid1))||s}async preloadSpecifyMatches(e){const t=new Set;e.forEach((e=>{e.specifyByName&&d()(e.specifyByName)&&t.add(d()(e.specifyByName))})),await this.specifyCache.preloadSpecifyMatches(t)}async processRegionMatching(e,t,n){const a=[],i=new Map,s={},o=new Map;for(const r of e){if(!r.regionName||r.regionName.length>85){a.push(r);continue}const e=r.regionName;o.has(e)||o.set(e,[]),o.get(e).push(r)}for(const[l,u]of o){const e=await(0,w.Lu)(l,this.strictFUse,this.fuzzyFUse);if(null===e||void 0===e||!e.length){u.forEach((e=>{const t="".concat(e.regionName,"-").concat(e.specifyByName||"","-").concat(this.aggregateBy||"");s[t]=null,a.push(e)}));continue}const o=new Map;u.forEach((e=>{const t=e.specifyByName||"";o.has(t)||o.set(t,[]),o.get(t).push(e)}));for(const[,l]of o){const o=l[0],u="".concat(o.regionName,"-").concat(o.specifyByName||"","-").concat(this.aggregateBy||"");let d=await(0,v.TK)(u,t);var c;if(void 0===d||n)d=await this.findBestMatchResultOptimized({directFuzzyMatchResult:e,specifyMatchValue:o.specifyByName}),((null===(c=d)||void 0===c?void 0:c.score)||0)>m.a&&(d=null),s[u]=d||null;l.forEach((e=>{r()(d)?a.push(e):i.set(e.rowId,d)}))}}return{matchResults:i,notMatchedItems:a,cacheToWrite:s}}clear(){this.specifyCache.clear(),this.fuzzyFUse=new s.Z([]),this.strictFUse=new s.Z([])}}async function k(e){let{locale:t,mapInfo:n,tableNode:a,geojson:i,allIndexOptions:o,dashboardData:r,hasGeoJSONChanged:c}=e;const u=[],h=[],p=i,{regionDimensionFieldID:M,regionIndexStatsFieldID:k,specifyByFieldID:S,regionConfig:I}=n,{dimension:b,aggregateBy:C,regionId:N,indexStatsMethod:z}=I;if("region"!==b||!M||!k||!p||!a)return null===p||void 0===p||p.features.map((e=>(e.properties=f()(e.properties,["aggregationValue","aggregationFormatValue"]),e))),{computingGeoJSON:p,notMatchedItems:u,totalItems:h};const F=N||"china",U=g()(o),B=a.rows||[],x=a.columns||[],O=JSON.stringify((null===x||void 0===x?void 0:x.find((e=>e.id===k)))||{}),D=x.find((e=>e.id===M)),A=x.find((e=>e.id===S)),R=new Map,V=new Map(p.features.map((e=>{var t;return[null===(t=e.properties)||void 0===t?void 0:t.id,e]}))),P=new Map(U.map((e=>[e.id,e.parentId]))),T=!!A;let L=[],Z=z||"sum";r&&"mean"!==Z?(l()(r,((e,t)=>{l()(e,((e,n)=>{L.push({regionName:d()(t),specifyByName:T?n:null,value:e.value,dashboardValue:void 0,rowId:"".concat(t,"-").concat(n)})}))})),"count"!==z&&"nonEmptyCount"!==z||(Z="sum")):L=B.reduce(((e,t)=>{const n=(0,w.hb)(t,D);if(!n)return e;const a=t.cells[k],i=t.id;return e.push({regionName:n,specifyByName:(0,w.hb)(t,A),value:a,rowId:i}),e}),[]),h.push(...L);const G=new E(function(e){const t=new s.Z(e,m.Hk),n=new s.Z(e,m.Yk),a=e.filter((e=>"ADM3"!==e.level)),i=new s.Z(a,m.Hk);return{strictFUse:n,fuzzyFUse:t,strictSpecifyFUse:new s.Z(a,m.Yk),fuzzySpecifyFUse:i}}(U),C);await G.preloadSpecifyMatches(L);const W=await(0,v.zK)(F);let j=new Map;try{const e=await G.processRegionMatching(L,W,c);j=e.matchResults,u.push(...e.notMatchedItems),await(0,v.Iv)(e.cacheToWrite,W)}finally{G.clear();try{null===W||void 0===W||W.close()}catch{}}for(const[s,l]of j){var q;const e=L.find((e=>e.rowId===s));if(!e||!l)continue;const t=null===(q=l.item)||void 0===q?void 0:q.id;if(!t)continue;const n=e.value;R.has(t)||R.set(t,[]),R.get(t).push({value:n,rowId:e.rowId,dashboardValue:e.dashboardValue});let a=t;for(let i=0;i<2;i++){const t=P.get(a);if(!t)break;R.has(t)||R.set(t,[]),R.get(t).push({value:n,rowId:e.rowId,dashboardValue:e.dashboardValue}),a=t}}for(const[s,l]of R){var _,Q,H;const e=V.get(s);if(!e||s===y.q)continue;const n="zh-CN"===t?(null===(_=e.properties)||void 0===_?void 0:_.display_name)||(null===(Q=e.properties)||void 0===Q?void 0:Q.name_zh):null===(H=e.properties)||void 0===H?void 0:H.name_en;e.type="Feature";const a=(0,w.vg)(l,Z);e.properties={...e.properties||{},name:n,aggregationValue:a,aggregationMethod:Z,rowIds:l.map((e=>{var t;return null===(t=e.rowId)||void 0===t?void 0:t.split("-")[0]})),indexStatsColumn:O}}const K=Array.from(R.keys()).map((e=>V.get(e))).filter((e=>{var t;return void 0!==e&&(null===(t=e.properties)||void 0===t?void 0:t.id)!==y.q})),{valueMap:J,totalSum:X,rankMap:Y}=(0,w.Hr)(K,[y.q]);for(const[s]of R){var $,ee;const e=V.get(s);if(!e||s===y.q)continue;const t=null===($=e.properties)||void 0===$?void 0:$.name,n=null===(ee=e.properties)||void 0===ee?void 0:ee.aggregationValue,a=J.get(s)||0,i=0!==X?a/X*100:null,o=Y.get(s)||null,r=(0,w.gB)({aggregationValue:n,indexStatsMethod:z,columns:x,regionIndexStatsFieldID:k,name:t,ratio:i,rank:o});e.properties={...e.properties||{},ratio:i,rank:o,tooltip:r}}return{computingGeoJSON:p,notMatchedItems:u,totalItems:h}}}}]);