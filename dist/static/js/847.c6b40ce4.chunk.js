"use strict";(self.webpackChunkmaptable_frontend=self.webpackChunkmaptable_frontend||[]).push([[847],{77847:(e,t,n)=>{n.r(t),n.d(t,{CheckoutForm:()=>f,default:()=>S});var i=n(57435),a=n(95620),s=n(95775),d=n(89166),l=n(88716),r=n.n(l),c=n(33718),o=n(48862),u=n(75617),m=n(68429),p=n(15328),v=n(49210);const _={content:"paymentStripe_content__3QSNs",amount:"paymentStripe_amount__d8G7H",button:"paymentStripe_button__Fx7io",spinner:"paymentStripe_spinner__JRiWd",loading:"paymentStripe_loading__VjTT1",info:"paymentStripe_info__mortz",icon:"paymentStripe_icon__vBGzi",iconFail:"paymentStripe_iconFail__DZf-o",iconWarning:"paymentStripe_iconWarning__XMd0z",iconSuccess:"paymentStripe_iconSuccess__Tzvk2",message:"paymentStripe_message__dOFP+",method:"paymentStripe_method__4GilD",title:"paymentStripe_title__suOiH",list:"paymentStripe_list__sHNlY",card:"paymentStripe_card__76MLa",active:"paymentStripe_active__p7n43",newCard:"paymentStripe_newCard__IHi6J",brand:"paymentStripe_brand__xPL1u",form:"paymentStripe_form__hRe8-",payment:"paymentStripe_payment__-IGU1"};var y=n(94553);function f(e){var t,n,l;const{clientSecret:o,order:m,onSyncPaySuccessStatus:p,onSyncPayFailedStatus:v}=e,f=(0,a.Z)(),S=(0,u.useStripe)(),h=(0,u.useElements)(),[g,j]=(0,i.useState)(!1),[x,P]=(0,i.useState)(r()(null===(t=m.customer)||void 0===t?void 0:t.cards)),[N,b]=(0,i.useState)(null===(n=m.customer)||void 0===n||null===(n=n.cards)||void 0===n?void 0:n.find((e=>e.default))),[C,k]=(0,i.useState)(!1),w=(0,i.useMemo)((()=>!S||!(null!==N&&void 0!==N&&N.id)&&!h||!g),[S,null===N||void 0===N?void 0:N.id,h,g]),Z=(0,i.useCallback)((()=>{if(h){var e;let t=h.getElement("payment");if(t||(t=h.create("payment",{layout:"tabs"})),!t)return!1;let n=h.getElement("linkAuthentication");n||(n=h.create("linkAuthentication",{defaultValues:m.customer?{email:m.customer.email}:void 0})),t.mount("#payment-element"),null===(e=n)||void 0===e||e.mount("#link-authentication-element")}return!0}),[h,m.customer]);(0,i.useEffect)((()=>{S&&o&&h&&S.retrievePaymentIntent(o).then((e=>{let{error:t,paymentIntent:n}=e;"requires_payment_method"!==(null===n||void 0===n?void 0:n.status)&&"requires_confirmation"!==(null===n||void 0===n?void 0:n.status)||(x&&Z(),j(!0))}))}),[S,o,h,x,Z]);return(0,y.jsxs)("div",{children:[(0,y.jsx)("div",{className:_.title,children:f.$t({id:"tpMBny",defaultMessage:"Choose card"})}),(0,y.jsx)("div",{className:_.method,children:(0,y.jsxs)(s.ZP.Group,{onChange:function(e){var t;if("newCard"===e.target.value){if(!Z())return;return b(void 0),void P(!0)}const n=null===(t=m.customer)||void 0===t||null===(t=t.cards)||void 0===t?void 0:t.find((t=>t.id===e.target.value));if(n&&h){const e=h.getElement("payment");null===e||void 0===e||e.unmount();const t=h.getElement("linkAuthentication");null===t||void 0===t||t.unmount()}b(n),P(!n)},defaultValue:N?N.id:"newCard",className:_.list,children:[null===(l=m.customer)||void 0===l||null===(l=l.cards)||void 0===l?void 0:l.map((e=>(0,y.jsx)(s.ZP,{value:e.id,children:(0,y.jsxs)("div",{className:(0,c.default)(_.card,{[_.active]:(null===N||void 0===N?void 0:N.id)===e.id}),children:[(0,y.jsxs)("div",{children:["*",e.last4]}),(0,y.jsx)("div",{className:_.brand,children:e.brand})]})}))),(0,y.jsx)(s.ZP,{value:"newCard",children:(0,y.jsx)("div",{className:(0,c.default)(_.newCard,{[_.active]:x}),children:f.$t({id:"Qr9zEi",defaultMessage:"Add new card"})})})]})}),(0,y.jsxs)("form",{id:"payment-form",className:_.form,children:[(0,y.jsxs)("div",{className:_.payment,children:[(0,y.jsx)("div",{id:"link-authentication-element"}),(0,y.jsx)("div",{id:"payment-element"})]}),(0,y.jsx)(d.ZP,{id:"submit",size:"large",className:_.button,disabled:w,loading:C||w,onClick:async e=>{if(e.preventDefault(),S&&o&&(h||null!==N&&void 0!==N&&N.id)){k(!0);try{if(!N&&h){if(!h.getElement("payment"))return void k(!1);h.submit()}const{error:e,paymentIntent:t}=await S.confirmPayment({elements:!N&&h?h:void 0,clientSecret:o,redirect:"if_required",confirmParams:{payment_method:null===N||void 0===N?void 0:N.id}});e?v("failed",null===e||void 0===e?void 0:e.message):p(t.id)}catch(e){v("failed")}}},children:w?f.$t({id:"gjBiyj",defaultMessage:"Loading..."}):f.$t({id:"7tOz+m",defaultMessage:"Pay now"})})]})]})}const S=e=>{var t;let{clientSecret:n,order:s,planService:d,onPaySuccess:l,onFinish:r}=e;const c=(0,a.Z)(),[S,h]=(0,i.useState)(!1),[g,j]=(0,i.useState)(),[x,P]=(0,i.useState)(),N=(0,o.J)(null!==(t="pk_live_51L8b87HyKdWcfiHZBeLLIIUQKKf9Ec6UohLlnv0ZIjFfugGPZtfrGnfeQJ5yHXFeZNPya7ii4MTB5hQqXvf0CHhn004g4JMOOO")?t:"");return(0,y.jsxs)("div",{className:_.content,children:[(0,y.jsxs)("div",{className:_.amount,children:[c.$t({id:"no6pRd",defaultMessage:"Payment amount\uff1a"}),(0,y.jsxs)("strong",{children:["USD ",(0,v.lB)(null===s||void 0===s?void 0:s.paymentAmount)]})]}),S?(0,y.jsxs)("div",{className:_.info,children:["paid"===g&&(0,y.jsx)(m.Z,{type:"checked",className:_.iconSuccess}),"failed"===g&&(0,y.jsx)(m.Z,{type:"alert",className:_.iconFail}),g&&(0,y.jsx)("div",{className:_.message,children:(0,p.vX)(c,g)}),g&&(0,y.jsx)("div",{className:_.message,children:decodeURIComponent(null!==x&&void 0!==x?x:"")})]}):s&&(0,y.jsx)(u.Elements,{options:{locale:"zh-CN"===c.locale?"zh":"en",clientSecret:n,appearance:{theme:"stripe"}},stripe:N,children:(0,y.jsx)(f,{clientSecret:n,order:s,onSyncPaySuccessStatus:async e=>{const{code:t,detail:n}=await d.syncStripePayStatus("succeeded",e);if(0===t){const e=new URL(n),t=e.searchParams.get("status"),i=e.searchParams.get("msg"),a="success"===t?"paid":"failed";j(a),i&&P(i),h(!0),"paid"===a&&s&&(null===r||void 0===r||r(),setTimeout((()=>{l(s.orderNo)}),2e3))}},onSyncPayFailedStatus:async(e,t)=>{await d.syncStripePayStatus("failed"),j(e),P(t),h(!0)}})})]})}}}]);