(()=>{"use strict";var e={23783:(e,o,t)=>{var a=t(20780),n=t(8942),i=t.n(n),r=t(74720),s=t.n(r),l=(t(34362),t(55349)),d=t.n(l),u=t(17646),c=t.n(u),p=t(56356),m=t.n(p),g=t(22787),f=t(468),v=t.n(f),h=t(53813),y=t.n(h),b=t(82813),I=t.n(b),w=t(42015),N=t(36441),x=t(46131),S=t(40978),F=t(13424),M=t(29630),O=t(93033);const V="optimized",D=("".concat("https://icon-cdn.maptable.com","/assets/boundary_data"),85);let j,_;async function k(e,o){const{id:t,locale:n,mapInfo:r,tableNode:l,regionGeojson:u,allIndexOptions:p,dashboardData:f}=e;o({id:t,type:"processing",data:{data:u,notMatchedItems:[],totalItems:[]}});try{const e=await async function(e){var o;let{locale:t,mapInfo:n,tableNode:r,geojson:l,allIndexOptions:u,dashboardData:p}=e;if("optimized"===V&&"region"===(null===n||void 0===n||null===(o=n.regionConfig)||void 0===o?void 0:o.dimension))return await(0,O.l)({locale:t,mapInfo:n,tableNode:r,geojson:l,allIndexOptions:u,dashboardData:p});const f=[],h=[],b=y()(l),{regionDimensionFieldID:x,regionIndexStatsFieldID:k,specifyByFieldID:B,regionConfig:C}=n,{dimension:P,aggregateBy:G,regionId:T,indexStatsMethod:J}=C;if(!x||!k||!b||!r)return null===b||void 0===b||b.features.map((e=>(e.properties=v()(e.properties,["aggregationValue","aggregationFormatValue"]),e))),{computingGeoJSON:b};(j&&!i()(x,j)||_&&!i()(k,_))&&(null===b||void 0===b||b.features.map((e=>(e.properties=v()(e.properties,["aggregationValue","aggregationFormatValue"]),e)))),j=x,_=k;const Z=T||"china";if("region"===P){const e=I()(u),o=new a.Z(e,w.Hk),n=new a.Z(e,w.Yk),i=r.rows||[],s=r.columns||[],l=JSON.stringify((null===s||void 0===s?void 0:s.find((e=>e.id===k)))||{}),g=s.find((e=>e.id===x)),v=s.find((e=>e.id===B)),y=new Map,S=new Map(b.features.map((e=>{var o;return[null===(o=e.properties)||void 0===o?void 0:o.id,e]}))),O=new Map(e.map((e=>[e.id,e.parentId]))),V=!!v;let j=[],_=J;p?(c()(p,((e,o)=>{c()(e,((e,t)=>{j.push({regionName:m()(o),specifyByName:V?t:null,value:e.value,dashboardValue:"mean"===_?e:void 0,rowId:o})}))})),"count"!==J&&"nonEmptyCount"!==J||(_="sum")):j=i.reduce(((e,o,t)=>{const a=(0,F.hb)(o,g);if(!a)return e;const n=o.cells[k],i=o.id;return e.push({regionName:a,specifyByName:(0,F.hb)(o,v),value:n,rowId:i}),e}),[]),h.push(...j);const C=await(0,M.zK)(Z),P=new Set(j.map((e=>"".concat(e.regionName,"-").concat(e.specifyByName||"","-").concat(G||"")))),T=await Promise.all([...P].map((e=>(0,M.TK)(e,C)))),E=new Map([...P].map(((e,o)=>[e,T[o]]))),L={};for(const t of j){var H;if(t.regionName&&t.regionName.length>D){f.push(t);continue}const e="".concat(t.regionName,"-").concat(t.specifyByName||"","-").concat(G||"");let a=E.get(e);if(void 0===a){var K;const i=await(0,F.Lu)(t.regionName,n,o);if(null===i||void 0===i||!i.length){L[e]=null;continue}a=await(0,F.XN)({directFuzzyMatchResult:i,specifyMatchValue:t.specifyByName,strictFUse:n,fuzzyFUse:o,aggregateBy:G}),((null===(K=a)||void 0===K?void 0:K.score)||0)>w.a&&(a=null),E.set(e,a||null),L[e]=a||null}if(d()(a)){f.push(t);continue}const i=null===(H=a.item)||void 0===H?void 0:H.id;if(!i){f.push(t);continue}const r=t.value,s=t.rowId;y.has(i)||y.set(i,[]),y.get(i).push({value:r,rowId:s,dashboardValue:t.dashboardValue});let l=i;for(let o=0;o<2;o++){const e=O.get(l);if(!e)break;y.has(e)||y.set(e,[]),y.get(e).push({value:r,rowId:s,dashboardValue:t.dashboardValue}),l=e}}await(0,M.Iv)(L,C);for(const[a,r]of y){var U,q,A;const e=S.get(a);if(!e)continue;if(a===N.q)continue;const o="zh-CN"===t?(null===(U=e.properties)||void 0===U?void 0:U.display_name)||(null===(q=e.properties)||void 0===q?void 0:q.name_zh):null===(A=e.properties)||void 0===A?void 0:A.name_en;e.type="Feature";let n=r.map((e=>e.value));if("mean"===_&&r.length>1){const{sum:e,count:o,isDashboardValue:t}=r.reduce(((e,o)=>(o.dashboardValue&&(e.sum+=o.dashboardValue.sum||0,e.count+=o.dashboardValue.count||0,e.isDashboardValue=!0),e)),{sum:0,count:0,isDashboardValue:!1});t&&(n=[o>0?e/o:0])}const i=z({aggregationValue:n,indexStatsMethod:J,columns:s,regionDimensionFieldID:x,regionIndexStatsFieldID:k,name:o});e.properties={...e.properties||{},name:o,tooltip:i,aggregationValue:n,aggregationMethod:_,rowIds:r.map((e=>e.rowId)),indexStatsColumn:l}}}else if("coordinate"===P){const e=r.rows,o=r.columns,a=new Map,n=JSON.stringify((null===o||void 0===o?void 0:o.find((e=>e.id===k)))||{});for(const i of e){const e=i.cells[x];if(e)try{const r=(0,S.HF)(e);if("Point"!==r.type)continue;let l=!1;h.push({regionName:i.cells[x],specifyByName:null,value:0,rowId:i.id});for(const e of b.features){const d="zh-CN"===t?s()(e,"properties.display_name")||s()(e,"properties.name_zh"):s()(e,"properties.name_en");if((0,g.Z)(r.coordinates,e)){var E,L,R;const t=null===(E=e.properties)||void 0===E?void 0:E.id;a.has(t)||a.set(t,[]),a.get(t).push({value:i.cells[k],rowId:i.id});const r=(null===(L=a.get(t))||void 0===L?void 0:L.map((e=>e.value)))||[],s=z({aggregationValue:r,indexStatsMethod:J,columns:o,regionDimensionFieldID:x,regionIndexStatsFieldID:k,name:d});e.type="Feature",e.properties={...e.properties||{},tooltip:s,name:d,aggregationValue:r,rowIds:(null===(R=a.get(t))||void 0===R?void 0:R.map((e=>e.rowId)))||[],indexStatsColumn:n},l=!0;break}}l||f.push({rowId:i.id,regionName:s()(i.cells,"".concat(x,"-fullAddress"),i.cells[x]),value:0,specifyByName:null})}catch{continue}}}return{computingGeoJSON:b,notMatchedItems:f,totalItems:h}}({locale:n,mapInfo:r,tableNode:l,geojson:u,allIndexOptions:p,dashboardData:f});o({id:t,type:"success",data:{data:e.computingGeoJSON,notMatchedItems:e.notMatchedItems||[],totalItems:e.totalItems||[]}})}catch(h){o({id:t,type:"failed",data:{data:u,notMatchedItems:[],totalItems:[]}})}}function z(e){var o,t;let{aggregationValue:a,indexStatsMethod:n,columns:i,regionDimensionFieldID:r,regionIndexStatsFieldID:s,name:l}=e;const d=(0,w.Bb)(a,n),u=null===i||void 0===i||null===(o=i.find((e=>e.id===r)))||void 0===o?void 0:o.name,c=null===i||void 0===i||null===(t=i.find((e=>e.id===s)))||void 0===t?void 0:t.name,p=d?(0,x.IG)(d):null;return"".concat(u,": ").concat(l,"\n").concat(null!==c&&void 0!==c?c:"Count",": ").concat(p)}const B=globalThis;B.onmessage=e=>{k(e.data,B.postMessage)}},46131:(e,o,t)=>{t.d(o,{IG:()=>i});t(74720),t(7070),t(75538),t(78587),t(75091);var a=t(99540),n=t.n(a);t(81659),t(21740),t(91671),t(42015),t(97102);function i(e){return function(e){const o=[{value:1e9,symbol:"b"},{value:1e6,symbol:"m"},{value:1e3,symbol:"k"}];if(e<1e3)return e.toString();for(const t of o)if(e>=t.value){const o=e/t.value,a=Math.floor(o).toString().length,n=Math.max(0,4-a);return o.toFixed(n).replace(/\.?0+$/,"")+t.symbol}return e.toString()}(function(e){if(0!==e&&e>-.1&&e<1){let o,t=e;for(o=0;o<10&&t>-.1&&t<1;o++)t*=10;return parseFloat(e.toFixed(o+2))}return parseFloat(n()(e).toFixed(3))}(e))}},91671:(e,o,t)=>{}},o={};function t(a){var n=o[a];if(void 0!==n)return n.exports;var i=o[a]={id:a,loaded:!1,exports:{}};return e[a].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}t.m=e,t.x=()=>{var e=t.O(void 0,[973,980,698,54,831,298],(()=>t(23783)));return e=t.O(e)},(()=>{var e=[];t.O=(o,a,n,i)=>{if(!a){var r=1/0;for(u=0;u<e.length;u++){a=e[u][0],n=e[u][1],i=e[u][2];for(var s=!0,l=0;l<a.length;l++)(!1&i||r>=i)&&Object.keys(t.O).every((e=>t.O[e](a[l])))?a.splice(l--,1):(s=!1,i<r&&(r=i));if(s){e.splice(u--,1);var d=n();void 0!==d&&(o=d)}}return o}i=i||0;for(var u=e.length;u>0&&e[u-1][2]>i;u--)e[u]=e[u-1];e[u]=[a,n,i]}})(),t.n=e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},t.d=(e,o)=>{for(var a in o)t.o(o,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:o[a]})},t.f={},t.e=e=>Promise.all(Object.keys(t.f).reduce(((o,a)=>(t.f[a](e,o),o)),[])),t.u=e=>973===e?"static/js/973.b6c5f644.js":980===e?"static/js/980.fe179d80.js":"static/js/"+e+"."+{54:"78a94c14",298:"aea3211d",698:"4d2febf4",831:"78dc763e"}[e]+".chunk.js",t.miniCssF=e=>{},t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),t.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o),t.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),t.p="./",(()=>{var e={524:1};t.f.i=(o,a)=>{e[o]||importScripts(t.p+t.u(o))};var o=self.webpackChunkmaptable_frontend=self.webpackChunkmaptable_frontend||[],a=o.push.bind(o);o.push=o=>{var n=o[0],i=o[1],r=o[2];for(var s in i)t.o(i,s)&&(t.m[s]=i[s]);for(r&&r(t);n.length;)e[n.pop()]=1;a(o)}})(),(()=>{var e=t.x;t.x=()=>Promise.all([973,980,698,54,831,298].map(t.e,t)).then(e)})();t.x()})();